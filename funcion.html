<!DOCTYPE html>
<html lang="es" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Colecciones - LinkApp</title>
  <link rel="stylesheet" href="estilos.css?v=1.2">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            bg: "#000000", surface: "#18181b", border: "#27272a",
            blue: "#38BDF8", teal: "#2DD4BF", text: "#E2E8F0", muted: "#94A3B8"
          }
        }
      }
    };

    const supabaseUrl = 'https://dvgcycyiphjmdnahjdvk.supabase.co/';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2Z2N5Y3lpcGhqbWRuYWhqZHZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjQxMzcsImV4cCI6MjA4NTI0MDEzN30.9QoKWLs0tiv9a_oapNSB5syPbpcUOeHekX0tBnzqYVI';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  </script>
</head>

<body class="min-h-screen flex flex-col bg-bg text-text relative overflow-x-hidden">
  <div class="bg-mesh"></div>

  <header class="border-b border-border sticky top-0 bg-bg/80 backdrop-blur-md z-50">
    <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="logo1.png" alt="logo" class="w-10 h-12">
        <span class="font-bold text-xl tracking-tighter text-white">LinkApp</span>
      </div>

      <div class="flex items-center gap-5">
        <div class="text-right hidden sm:block">
          <p id="userNicknameDisplay" class="text-sm font-black text-white leading-none italic uppercase">Cargando...</p>
          <button onclick="logout()" class="text-[9px] text-red-400 hover:text-red-300 uppercase tracking-widest mt-1 font-bold">
            Desconectar
          </button>
        </div>

        <div class="relative">
          <input type="file" id="avatarInput" class="hidden" accept="image/*" onchange="cambiarAvatar(event)">
          
          <button onclick="toggleUserMenu()" 
            class="w-12 h-12 rounded-full border-2 border-border bg-surface overflow-hidden hover:border-blue transition-all shadow-lg active:scale-95 group relative">
            <img id="userAvatarDisplay" src="" alt="Perfil" class="w-full h-full object-cover hidden">
            <div id="avatarFallback" class="w-full h-full flex items-center justify-center bg-blue/10 text-blue font-bold">?</div>
            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-[8px] font-bold">EDITAR</span>
            </div>
          </button>

          <div id="userDropdown" class="hidden absolute right-0 mt-3 w-56 bg-surface border border-border rounded-2xl shadow-2xl overflow-hidden z-50 animate-fade-in">
            <div class="px-4 py-4 border-b border-border bg-bg/20 text-center">
              <p class="text-[10px] text-muted uppercase font-black tracking-widest mb-2">Cuenta</p>
              <p id="userNicknameMenu" class="font-bold text-white truncate italic">Cargando...</p>
            </div>
            <div class="p-2">
              <button onclick="document.getElementById('avatarInput').click()" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-muted hover:bg-bg hover:text-blue rounded-xl transition">
                <span>üì∏</span> Cambiar Foto
              </button>
              <a href="perfil.html" class="flex items-center gap-3 px-3 py-2 text-sm text-muted hover:bg-bg hover:text-blue rounded-xl transition">
                <span>üë§</span> Editar Perfil
              </a>
              <a href="suscripcion2.html" class="flex items-center gap-3 px-4 py-3 text-sm text-muted hover:bg-bg hover:text-purple rounded-xl transition-all group border-y border-border/10">
                <span class="group-hover:scale-110 transition-transform">üíé</span> 
                <span class="font-medium">Suscripci√≥n Pro</span>
              </a>
              <button onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-xl transition">
                <span>üö™</span> Cerrar sesi√≥n
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-12 w-full flex-grow">
    <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
      <div>
        <h1 class="text-4xl font-black tracking-tight text-white mb-2">Mis <span class="gradient-text">Colecciones</span></h1>
        <p class="text-muted text-sm font-medium">Gestiona y comparte tus espacios de trabajo digitales.</p>
      </div>
      <button onclick="nuevaCarpeta()" 
        class="px-8 py-3 bg-blue hover:bg-blue/90 text-black font-black rounded-xl transition-all shadow-lg shadow-blue/20 active:scale-95 uppercase tracking-widest text-xs">
        + Nueva Carpeta
      </button>
    </div>

    <div id="folderGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
  </main>

  <div id="shareModal" class="share-overlay hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-6">
    <div class="share-box bg-surface border border-border p-8 rounded-[2.5rem] w-full max-w-sm">
      <h3 class="text-xl font-black text-white mb-6 text-center tracking-tight uppercase">Compartir <span class="text-blue">Carpeta</span></h3>
      <div class="grid grid-cols-2 gap-3 mb-8">
        <button class="flex flex-col items-center gap-2 p-4 bg-bg rounded-2xl border border-border hover:border-blue transition-all" onclick="shareWhatsApp()">
          <span class="text-2xl">üì±</span> <span class="text-[10px] font-bold uppercase tracking-widest">WhatsApp</span>
        </button>
        <button class="flex flex-col items-center gap-2 p-4 bg-bg rounded-2xl border border-border hover:border-blue transition-all" onclick="shareFacebook()">
          <span class="text-2xl">üîµ</span> <span class="text-[10px] font-bold uppercase tracking-widest">Facebook</span>
        </button>
        <button class="flex flex-col items-center gap-2 p-4 bg-bg rounded-2xl border border-border hover:border-blue transition-all" onclick="shareTelegram()">
          <span class="text-2xl">‚úàÔ∏è</span> <span class="text-[10px] font-bold uppercase tracking-widest">Telegram</span>
        </button>
        <button class="flex flex-col items-center gap-2 p-4 bg-bg rounded-2xl border border-border hover:border-blue transition-all" onclick="copyShare()">
          <span class="text-2xl">üîó</span> <span class="text-[10px] font-bold uppercase tracking-widest">Copiar</span>
        </button>
      </div>
      <button class="w-full py-3 text-muted text-[10px] font-black uppercase tracking-widest hover:text-white transition" onclick="cerrarShare()">
        Cerrar ventana
      </button>
    </div>
  </div>

  <footer class="border-t border-border py-10 bg-surface/30">
    <div class="max-w-7xl mx-auto px-6 flex flex-col items-center gap-4">
      <img src="logo1.png" alt="Logo mini" class="w-8 h-10 grayscale opacity-40">
      <p class="text-muted/40 text-[10px] uppercase tracking-[0.3em] font-medium">¬© 2026 LinkApp Environment</p>
    </div>
  </footer>

  <script>
    let currentUser = null;
    let carpetas = JSON.parse(localStorage.getItem('carpetas')) || [];
    let textoCompartir = "";

    window.addEventListener('load', async function() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();

      if (error || !user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      
      // PRIORIDAD 1: Nickname del LocalStorage (reci√©n ingresado en registro-perfil)
      // PRIORIDAD 2: Nickname de metadata de Supabase
      const savedNick = localStorage.getItem('userNickname') || user.user_metadata.nickname || user.email.split('@')[0];
      
      document.getElementById('userNicknameDisplay').textContent = savedNick;
      document.getElementById('userNicknameMenu').textContent = savedNick;
      
      actualizarInterfazAvatar();
      renderCarpetas();
    });

    function actualizarInterfazAvatar() {
      const avatarImg = document.getElementById('userAvatarDisplay');
      const fallback = document.getElementById('avatarFallback');
      const savedAvatar = localStorage.getItem('userAvatar') || currentUser.user_metadata.avatar_url;

      if (savedAvatar) {
        avatarImg.src = savedAvatar;
        avatarImg.classList.remove('hidden');
        fallback.classList.add('hidden');
      } else {
        const nick = document.getElementById('userNicknameDisplay').textContent;
        fallback.textContent = nick.charAt(0).toUpperCase();
        avatarImg.classList.add('hidden');
        fallback.classList.remove('hidden');
      }
    }

    async function cambiarAvatar(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64Image = e.target.result;
          
          // Guardar localmente para respuesta inmediata
          localStorage.setItem('userAvatar', base64Image);
          
          // Opcional: Intentar guardar en metadata de Supabase
          await supabaseClient.auth.updateUser({
            data: { avatar_url: base64Image }
          });

          actualizarInterfazAvatar();
        };
        reader.readAsDataURL(file);
      }
    }

    function toggleUserMenu() {
      document.getElementById("userDropdown").classList.toggle("hidden");
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      localStorage.clear();
      window.location.href = 'login.html';
    }

    /* ================= SISTEMA DE CARPETAS (CORREGIDO) ================= */
    function guardarYRenderizar() {
      localStorage.setItem('carpetas', JSON.stringify(carpetas));
      renderCarpetas();
    }

    function renderCarpetas() {
      const grid = document.getElementById('folderGrid');
      grid.innerHTML = ''; // Limpiar grid

      if (carpetas.length === 0) {
        grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 border-2 border-dashed border-border rounded-[2.5rem] bg-surface/20">
            <span class="text-4xl mb-4 opacity-20">üìÅ</span>
            <p class="text-muted font-bold uppercase tracking-widest text-xs">Tu biblioteca est√° vac√≠a</p>
          </div>`;
        return;
      }

      carpetas.forEach((folder, fIndex) => {
        const card = document.createElement('div');
        card.className = "folder-card border border-border rounded-[2rem] p-6 flex flex-col h-full bg-surface/10 backdrop-blur-sm transition-all hover:border-blue/30";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-6">
            <div class="max-w-[70%]">
              <h3 class="text-xl font-black text-white leading-tight mb-1 truncate">${folder.nombre}</h3>
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue animate-pulse"></span>
                <span class="text-[10px] text-muted uppercase font-black tracking-tighter">${folder.links ? folder.links.length : 0} Elementos</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="abrirCompartir(${fIndex})" class="w-8 h-8 flex items-center justify-center bg-surface border border-border rounded-lg hover:border-blue transition-colors text-xs">üì§</button>
              <button onclick="eliminarCarpeta(${fIndex})" class="w-8 h-8 flex items-center justify-center bg-surface border border-border rounded-lg hover:border-red-500 transition-colors text-xs text-red-400">üóë</button>
            </div>
          </div>
          <div id="links-container-${fIndex}" class="space-y-2 mb-6 flex-grow overflow-y-auto max-h-56 pr-2 custom-scroll">
            ${(folder.links || []).map((link, lIndex) => `
              <div class="link-wrapper flex justify-between items-center bg-bg/40 border border-border/50 p-3 rounded-xl group hover:bg-bg transition-colors">
                <div class="flex flex-col overflow-hidden max-w-[80%]">
                   <a href="${link.url}" target="_blank" class="truncate text-[11px] font-bold text-white group-hover:text-blue transition-colors">${link.nombre}</a>
                   <span class="text-[9px] text-muted/50 truncate">${link.url.replace(/^https?:\/\//, '')}</span>
                </div>
                <button onclick="eliminarEnlace(${fIndex}, ${lIndex})" class="text-red-400/50 hover:text-red-400 text-[10px]">‚úï</button>
              </div>
            `).join('')}
          </div>
          <button onclick="agregarEnlace(${fIndex})" class="w-full py-3 bg-blue/5 hover:bg-blue/10 text-blue border border-blue/10 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all">
            + A√±adir Enlace
          </button>
        `;
        grid.appendChild(card);
      });
    }

    function nuevaCarpeta() {
      const n = prompt("Nombre de la nueva colecci√≥n:");
      if (n && n.trim() !== "") {
        carpetas.push({ nombre: n, links: [] });
        guardarYRenderizar();
      }
    }

    function eliminarCarpeta(i) {
      if (confirm("¬øEliminar carpeta definitivamente?")) {
        carpetas.splice(i, 1);
        guardarYRenderizar();
      }
    }

    function agregarEnlace(i) {
      const url = prompt("Pega la URL del enlace:");
      if (url) {
        const nombre = prompt("¬øQu√© nombre (etiqueta) le quieres poner?");
        if (nombre) {
          const finalUrl = url.startsWith('http') ? url : `https://${url}`;
          if(!carpetas[i].links) carpetas[i].links = [];
          carpetas[i].links.push({ nombre: nombre, url: finalUrl });
          guardarYRenderizar();
        }
      }
    }

    function eliminarEnlace(fi, li) {
      carpetas[fi].links.splice(li, 1);
      guardarYRenderizar();
    }

    /* ================= COMPARTIR ================= */
    async function abrirCompartir(index) {
      try {
        const carpeta = carpetas[index];
        const nick = document.getElementById('userNicknameDisplay').textContent;
        
        const { data, error } = await supabaseClient
          .from('carpetas')
          .insert([{ 
            nombre: carpeta.nombre, 
            links: carpeta.links, 
            user_nickname: nick,
            user_id: currentUser.id 
          }])
          .select();

        if (error) throw error;

        const shareId = data[0].id;
        const urlPublica = `${window.location.origin}/view.html?id=${shareId}`;
        textoCompartir = `¬°Mira mi colecci√≥n "${carpeta.nombre}" en LinkApp!\n\nLink: ${urlPublica}`;
        document.getElementById("shareModal").classList.remove("hidden");
      } catch (err) {
        alert("Error al generar enlace seguro.");
      }
    }

    function cerrarShare() { document.getElementById("shareModal").classList.add("hidden"); }
    function copyShare() { navigator.clipboard.writeText(textoCompartir); alert("Copiado ‚úî"); cerrarShare(); }
    function shareWhatsApp() { window.open(`https://wa.me/?text=${encodeURIComponent(textoCompartir)}`); cerrarShare(); }
    function shareFacebook() { window.open(`https://www.facebook.com/sharer/sharer.php?quote=${encodeURIComponent(textoCompartir)}`); cerrarShare(); }
    function shareTelegram() { window.open(`https://t.me/share/url?text=${encodeURIComponent(textoCompartir)}`); cerrarShare(); }

    window.addEventListener("click", function(e) {
      if (!e.target.closest("#userDropdown") && !e.target.closest("button[onclick='toggleUserMenu()']")) {
        document.getElementById("userDropdown").classList.add("hidden");
      }
    });
  </script>
</body>
</html>